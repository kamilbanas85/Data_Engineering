------------------------------------------------------------------------------------------------
--- stored procedure to creat table based on few diffrent sources

  SET ANSI_NULLS ON
  GO
  
  SET QUOTED_IDENTIFIER ON
  GO
  
  
  CREATE  procedure [schema_name].[Sp_load_table_finall]
  AS
  Begin
  
  	--------------------------------------------------------------
  	--------------------------------------------------------------
  	------ BASE date table----------------------------------------
  	--------------------------------------------------------------
  
  	WITH date_table AS
  		(SELECT CONVERT(DATE, '2016-01-01') as [date]
  		  UNION ALL
  		  SELECT DATEADD(day, 1, [date])
  		  FROM date_table
  		  WHERE DATEADD(day, 1, [date]) <= GETDATE()
  	)
  	SELECT [date]
  	into #temp_date
  	FROM date_table
  	OPTION (MAXRECURSION 0)
  
  	--------------------------------------------------------------
  	--------------------------------------------------------------
  	------ table 1--------------------------------------------------
  	--------------------------------------------------------------
  	--- 
  
  	SELECT *
  	into #tmp_tab_01
  	FROM [schama_01].[table_01]
  
  	--------------------------------------------------------------
  	--------------------------------------------------------------
  	------ table 1-------------------------------------------------
  	--------------------------------------------------------------
  	--- 
  
  	SELECT *
  	into #tmp_tab_02
  	FROM [schama_02].[table_02]
  
    ----------------------------------------------------------------------------------------------------------------------------
  	----------------------------------------------------------------------------------------------------------------------------
  	------ JOINT temporaty tables into one -------------------------------------------------------------------------------------
  	----------------------------------------------------------------------------------------------------------------------------
  	----------------------------------------------------------------------------------------------------------------------------
  	
  	truncate table [schama_finall].[table_finall]
  
  	-- table shoud be defined and should have columns data type
  	INSERT INTO [schama_finall].[table_finall](
  
  	                 [date]
  					,[col1]
  					,[col2]
  					,[col3]
  					,[col4]
  	)
  	SELECT 
  		 temp_date.[date]           as [date]
  --
  		,tmp_tab_01.[col_01]        as [col1]
  		,tmp_tab_01.[col_02]        as [col2] 
  		,tmp_tab_02.[col_01]        as [col3]
  		,tmp_tab_02.[col_02]        as [col4]
  		
  	FROM #temp_date as temp_date
  	LEFT JOIN #tmp_tab_01 as tmp_tab_01
  	ON temp_date.[date] = tmp_tab_01.[date]
  	LEFT JOIN #tmp_tab_02 as tmp_tab_02
  	ON temp_date.[date] = tmp_tab_02.[date]
  	
  
  	----------------------------------------------------------------------------------------------------------------------------
  	----------------------------------------------------------------------------------------------------------------------------
  	------ REMOVE temporaty tables -------------------------------------------------------------------------------------
  	----------------------------------------------------------------------------------------------------------------------------
  	----------------------------------------------------------------------------------------------------------------------------
  
  	drop table #temp_date
  	drop table #tmp_tab_01
  	drop table #tmp_tab_02
  
  End
  GO


----------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------
---- Join tables dirrfernt method


  SELECT *
  FROM 
  (
    	SELECT  [date]
  	       ,[col1] as [value]
  		   ,'desc_1' as [descriprion]
    	FROM [schama_01].[table_01]
  
  	UNION ALL
  
    	SELECT  [date]
  	       ,[col5] as [value]
  		   ,'desc_2' as [descriprion]
    	FROM [schama_02].[table_02]
  
  	UNION ALL
  
    	SELECT  [date]
  	       ,[col111] as [value]
  		   ,'desc_3' as [descriprion]
    	FROM [schama_03].[table_03]
  
  
  ) src
  pivot
  (
  	SUM([value])
    for [descriprion] in (
  			,[desc_1]
  			,[desc_2]
  			,[desc_3]) 
    ) piv
  order by dateCET
  GO
